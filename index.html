<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обробка фотографій портретів</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .control-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 18px;
        }
        select, input[type="text"], input[type="file"] {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 300px;
            max-width: 100%;
        }
        button {
            padding: 12px 30px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        #imageContainer {
            max-width: 800px;
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 0 auto;
        }
        #imageContainer img {
            max-width: 100%;
            height: auto;
        }
        canvas {
            max-width: 800px;
            max-height: 600px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .message {
            font-size: 20px;
            color: #28a745;
            margin: 20px 0;
        }
        /* Loading step: spinner */
        .loading-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            width: 100%;
            margin: 40px 0;
        }
        .loading-label {
            font-size: 18px;
            color: #333;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #e6e6e6;
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
</head>
<body>
    <div class="container">
        <h1>Обробка фотографій портретів</h1>
        
        <!-- Step 1: Upload Photo -->
        <div id="step1" class="step active">
            <div class="control-group">
                <label>Завантажте фотографію</label>
                <input type="file" id="upload" accept="image/*" style="display: none;">
                <button id="uploadBtn">Завантажити фото</button>
            </div>
        </div>

        <!-- Step 1.5: Loading Photo -->
        <div id="step1_5" class="step">
            <div class="loading-wrapper">
                <div class="spinner" aria-label="loading"></div>
                <div class="loading-label">Ваше фото обробляється...</div>
            </div>
        </div>

        <!-- Step 2: Enter Name and Position -->
        <div id="step2" class="step">
            <div class="control-group">
                <label for="position">Посада:</label>
                <select id="position">
                    <option value="викладач">Викладач</option>
                    <option value="асистент">Асистент</option>
                    <option value="аспірант">Аспірант</option>
                </select>
            </div>
            <div class="control-group">
                <label for="name">Ім'я:</label>
                <input type="text" id="name" placeholder="Білецький Б.С.">
            </div>
            <button id="continueBtn">Продовжити</button>
        </div>

        <!-- Step 3: Crop for Web -->
        <div id="step3" class="step">
            <div id="output">
                <div id="imageContainer"></div>
            </div>
            <button id="cropWebBtn">Застосувати обрізання</button>
        </div>

        <!-- Step 3.5: Show Web Result -->
        <div id="step3_5" class="step">
            <div id="output">
                <canvas id="canvasWeb"></canvas>
            </div>
            <button id="toPrintBtn">Перейти до обрізання для друку</button>
        </div>

        <!-- Step 4: Crop for Print -->
        <div id="step4" class="step">
            <div id="output">
                <div id="imageContainer2"></div>
            </div>
            <button id="cropPrintBtn">Застосувати обрізання</button>
        </div>

        <!-- Step 4.5: Show Print Result -->
        <div id="step4_5" class="step">
            <div id="output">
                <canvas id="canvasPrint"></canvas>
            </div>
            <button id="saveBtn">Зберегти два зображення</button>
        </div>

        <!-- Step 5: Completion -->
        <div id="step5" class="step">
            <p class="message">Вітаю, одне фото готове. Перейдемо до іншого?</p>
            <button id="restartBtn">Так, давай ще!</button>
        </div>
    </div>

    <script type="module">
        import { removeBackground } from '@imgly/background-removal';
        import Cropper from 'cropperjs';
        import JSZip from 'jszip';
        import { jsPDF } from 'jspdf';

        // Register service worker for caching WASM and assets
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/SAIT-photo/sw.js').then(() => {
                console.log('Service Worker registered for caching');
            }).catch((err) => {
                console.log('Service Worker registration failed:', err);
            });
        }

        // GitHub Pages note: cannot set COOP/COEP headers, so multi-threaded WASM falls back.
        // Using WebGPU acceleration when available for better performance.
        if (!crossOriginIsolated) {
            console.info('Cross-origin isolation not enabled. Using WebGPU acceleration for faster processing on GitHub Pages.');
        }

        // Preload WASM model immediately on page load for faster first-time processing
        (async () => {
            try {
                console.log('Preloading background removal model...');
                await removeBackground(new Blob([new Uint8Array(1)], { type: 'image/png' }), {
                    device: 'gpu'
                }).catch(() => {});
                console.log('Model preloaded successfully');
            } catch (e) {
                console.log('Model preload skipped');
            }
        })();

        // Helper function to downsize image if too large
        async function downsizeImage(file, maxHeight = 1748) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    let { width, height } = img;
                    
                    // Only downsize if height exceeds limit
                    if (height > maxHeight) {
                        const scale = maxHeight / height;
                        width = Math.round(width * scale);
                        height = maxHeight;
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            resolve(blob || file);
                        }, 'image/jpeg', 0.85);
                    } else {
                        // No downsizing needed, return original
                        resolve(file);
                    }
                };
                
                img.onerror = () => resolve(file);
                img.src = URL.createObjectURL(file);
            });
        }

        const upload = document.getElementById('upload');
        const uploadBtn = document.getElementById('uploadBtn');
        const nameInput = document.getElementById('name');
        const positionSelect = document.getElementById('position');
        const continueBtn = document.getElementById('continueBtn');
        const cropWebBtn = document.getElementById('cropWebBtn');
        const toPrintBtn = document.getElementById('toPrintBtn');
        const cropPrintBtn = document.getElementById('cropPrintBtn');
        const saveBtn = document.getElementById('saveBtn');
        const restartBtn = document.getElementById('restartBtn');
        const imageContainer = document.getElementById('imageContainer');
        const imageContainer2 = document.getElementById('imageContainer2');
        const canvasWeb = document.getElementById('canvasWeb');
        const canvasPrint = document.getElementById('canvasPrint');
        const ctxWeb = canvasWeb.getContext('2d');
        const ctxPrint = canvasPrint.getContext('2d');

        const positions = ['викладач', 'асистент', 'аспірант'];
        const shortPositions = ['викл.', 'ас.', 'асп.'];
        const bgColors = ['#3C60AA', '#ACD6F3', '#8CB8E4'];

        let currentStep = 1;
        let uploadedFile = null;
        let resultBlob = null;
        let cropperWeb = null;
        let cropperPrint = null;
        let croppedWebCanvas = null;
        let croppedPrintCanvas = null;

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        uploadBtn.addEventListener('click', () => {
            upload.click();
        });

        upload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            uploadedFile = file;
            
            try {
                // Show loading step while processing background removal
                showStep('1_5');
                
                // Downsize image if height exceeds 1748px before processing
                const downsizedFile = await downsizeImage(file, 1748);
                console.log(`Original: ${file.size} bytes, Downsized: ${downsizedFile.size} bytes`);
                
                // Use GPU when available for faster processing without threads
                resultBlob = await removeBackground(downsizedFile, {
                    device: 'gpu',  // GPU acceleration, falls back to CPU if unavailable
                    progress: (key, current, total) => {
                        console.log(`${key}: ${current}/${total}`);
                    }
                });
                showStep(2);
            } catch (error) {
                console.error('Помилка обробки:', error);
                alert('Сталася помилка під час обробки зображення.');
                // Return to upload step on error
                showStep(1);
            }
        });

        continueBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (!name) {
                alert('Будь ласка, введіть ім\'я.');
                return;
            }
            
            // Show cropper for web
            imageContainer.innerHTML = '';
            const imgElement = document.createElement('img');
            imgElement.src = URL.createObjectURL(resultBlob);
            imgElement.style.maxWidth = '100%';
            imgElement.onload = () => {
                cropperWeb = new Cropper(imgElement, {
                    aspectRatio: 360 / 500,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    zoomable: false,
                    scalable: false,
                    rotatable: false,
                });
            };
            imageContainer.appendChild(imgElement);
            showStep(3);
        });

        cropWebBtn.addEventListener('click', () => {
            if (!cropperWeb) return;
            croppedWebCanvas = cropperWeb.getCroppedCanvas();
            
            // Apply background and size for web
            const posIndex = positionSelect.selectedIndex;
            const bgColor = bgColors[posIndex];
            canvasWeb.width = 360;
            canvasWeb.height = 500;
            ctxWeb.fillStyle = bgColor;
            ctxWeb.fillRect(0, 0, 360, 500);
            ctxWeb.drawImage(croppedWebCanvas, 0, 0, 360, 500);
            
            cropperWeb.destroy();
            cropperWeb = null;
            showStep('3_5');
        });

        toPrintBtn.addEventListener('click', () => {
            // Show cropper for print
            imageContainer2.innerHTML = '';
            const imgElement = document.createElement('img');
            imgElement.src = URL.createObjectURL(resultBlob);
            imgElement.style.maxWidth = '100%';
            imgElement.onload = () => {
                cropperPrint = new Cropper(imgElement, {
                    aspectRatio: 105 / 148,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    zoomable: false,
                    scalable: false,
                    rotatable: false,
                });
            };
            imageContainer2.appendChild(imgElement);
            showStep(4);
        });

        cropPrintBtn.addEventListener('click', () => {
            if (!cropperPrint) return;
            croppedPrintCanvas = cropperPrint.getCroppedCanvas();
            
            // Apply background and size for print
            const posIndex = positionSelect.selectedIndex;
            const bgColor = bgColors[posIndex];
            // Exact pixel dimensions for 105mm x 148mm at 300 DPI
            const printWidth = 1240;  // 105mm -> 4.13386in * 300 = 1240.158
            const printHeight = 1748; // 148mm -> 5.82677in * 300 = 1748.03
            canvasPrint.width = printWidth;
            canvasPrint.height = printHeight;
            ctxPrint.fillStyle = bgColor;
            ctxPrint.fillRect(0, 0, printWidth, printHeight);
            ctxPrint.drawImage(croppedPrintCanvas, 0, 0, printWidth, printHeight);
            
            cropperPrint.destroy();
            cropperPrint = null;
            showStep('4_5');
        });

        saveBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const posIndex = positionSelect.selectedIndex;
            const shortPos = shortPositions[posIndex];
            const filename = `${shortPos} ${name}`;
            
            const zip = new JSZip();
            
            // Add web PNG
            const webBlob = await new Promise(resolve => canvasWeb.toBlob(resolve, 'image/png'));
            zip.file(`${filename} - на сайт.png`, webBlob);
            
            // Add print JPG
            const printBlob = await new Promise(resolve => canvasPrint.toBlob(resolve, 'image/jpeg', 0.9));
            zip.file(`${filename} - на друк.jpg`, printBlob);

            // Add PDF (A6 105x148 mm) embedding the print image to exact size
            const pdf = new jsPDF({ unit: 'mm', format: [105, 148] });
            // Convert print canvas to data URL (JPEG)
            const printDataUrl = canvasPrint.toDataURL('image/jpeg', 0.9);
            // Place image to fill entire page (105 x 148 mm)
            pdf.addImage(printDataUrl, 'JPEG', 0, 0, 105, 148);
            const pdfBlob = pdf.output('blob');
            zip.file(`${filename} - на друк.pdf`, pdfBlob);
            
            // Generate ZIP
            const zipBlob = await zip.generateAsync({type: 'blob'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = `${filename}.zip`;
            link.click();
            
            showStep(5);
        });

        restartBtn.addEventListener('click', () => {
            // Reset everything
            upload.value = '';
            nameInput.value = '';
            positionSelect.selectedIndex = 0;
            uploadedFile = null;
            resultBlob = null;
            croppedWebCanvas = null;
            croppedPrintCanvas = null;
            imageContainer.innerHTML = '';
            imageContainer2.innerHTML = '';
            showStep(1);
        });
    </script>
</body>
</html>
